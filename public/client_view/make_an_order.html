<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Place Order from Agreements</title>
  <style>
    body { font-family: Arial; margin: 40px; background: #fafafa; }
    .form-section { 
      margin-top: 20px; 
      background: #fff; 
      padding: 20px; 
      border-radius: 10px; 
      width: 500px; 
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
    }
    button { margin-top: 10px; padding: 8px 15px; cursor: pointer; }
    .agreement-button { 
      display: block; 
      margin: 10px 0; 
      padding: 10px; 
      width: 100%; 
      text-align: left; 
      border: 1px solid #ccc; 
      border-radius: 5px; 
      background: #f5f5f5; 
    }
    #order-status { margin-top: 15px; font-weight: bold; color: green; }
  </style>
</head>
<body>
  <h1>Place Order</h1>

  <!-- Step 1: Enter client email -->
  <div id="email-section" class="form-section">
    <label>Email Address:</label>
    <input type="email" id="email_address" required>
    <button onclick="loadAgreements()">Show My Agreements</button>
    <p id="email-status"></p>
  </div>

  <!-- Step 2: Show Agreements -->
  <div id="agreements-section" class="form-section" style="display:none;">
    <h3>Click an Agreement to Place Order</h3>
    <div id="agreements-list"></div>
    <p id="order-status"></p>
  </div>

  <script>
    // Load agreements for a client by email
    async function loadAgreements() {
      const email = document.getElementById("email_address").value.trim();
      const status = document.getElementById("email-status");
      if (!email) { 
        status.textContent = "Please enter an email."; 
        return; 
      }

      status.textContent = "Loading agreements...";
      try {
        const res = await fetch(`http://localhost:3000/api/client/agreements/number?email_address=${email}`);
        const agreements = await res.json();

        if (!agreements || agreements.length === 0) {
          status.textContent = "No agreements found for this email.";
          return;
        }

        document.getElementById("agreements-section").style.display = "block";
        document.getElementById("email-section").style.display = "none";

        const list = document.getElementById("agreements-list");
        list.innerHTML = "";

        agreements.forEach(a => {
          const btn = document.createElement("button");
          btn.className = "agreement-button";
          btn.textContent = `${a.cut_type_of_choice} (Week ${a.week_of_delivery})`;
          btn.onclick = () => placeOrder(a.agreement_no);
          list.appendChild(btn);
        });

        status.textContent = "";
      } catch (err) {
        status.textContent = "Error loading agreements.";
        console.error(err);
      }
    }

    // Place order for a selected agreement
    async function placeOrder(agreement_no) {
      const email = document.getElementById("email_address").value.trim();
      const status = document.getElementById("order-status");
      status.textContent = "Placing order...";

      try {
        const res = await fetch("http://localhost:3000/api/client/order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            email_address: email, 
            agreements: [agreement_no] // send as array
          })
        });

        const result = await res.json();
        status.textContent = result.message || result.error;
      } catch (err) {
        status.textContent = "Failed to place order.";
        console.error(err);
      }
    }
  </script>
</body>
</html>