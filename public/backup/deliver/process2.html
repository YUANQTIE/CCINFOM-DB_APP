<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Assign Deliveries</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  select, button { margin: 5px 0; padding: 5px; }
  .order-line { border: 1px solid #ccc; padding: 10px; margin: 5px 0; }
</style>
</head>
<body>

<h2>Select a Pending Delivery</h2>
<select id="deliverySelect">
  <option value="">-- Select Delivery --</option>
</select>

<div id="orderLinesContainer"></div>

<script>
/* --------------------------------------------------
   Load Pending Deliveries
-------------------------------------------------- */
async function fetchPendingDeliveries() {
  const res = await fetch("http://localhost:3000/api/company/pending-deliveries");
  const deliveries = await res.json();

  const select = document.getElementById("deliverySelect");
  deliveries.forEach(d => {
    const option = document.createElement("option");
    option.value = d.delivery_no;
    option.textContent = `${d.delivery_no} - ${d.restaurant_name} (${d.truck_number})`;
    select.appendChild(option);
  });
}

/* --------------------------------------------------
   Load Order Lines
-------------------------------------------------- */
async function fetchOrderLines(deliveryNo) {
  const res = await fetch(`http://localhost:3000/api/company/pending-deliveries/${deliveryNo}/order-lines`);
  const orderLines = await res.json();

  const container = document.getElementById("orderLinesContainer");
  container.innerHTML = ""; // clear list

  orderLines.forEach(async ol => {
    const div = document.createElement("div");
    div.className = "order-line";

    div.innerHTML = `
      <strong>Cut Type:</strong> ${ol.cut_type_of_choice}<br>
      <strong>Weight:</strong> ${ol.weight}<br><br>

      <label>Pick Meat Selection:</label>
      <select class="meatSelect">
        <option value="">-- Select --</option>
      </select>
      <br><br>

      <button class="reserveBtn">Reserve</button>
    `;

    container.appendChild(div);

    /* --------------------------------------------------
       Load Meat Selections (MATCHES YOUR SQL EXACTLY)
    -------------------------------------------------- */
    const meatRes = await fetch(`http://localhost:3000/api/order-line/${ol.id}/meat-selection`);
    const meatData = await meatRes.json();   // â† FIXED: only call json() ONCE

    console.log("Meat selection for OL", ol.id, meatData);

    const meatSelect = div.querySelector(".meatSelect");

    if (meatData.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No available match";
      meatSelect.appendChild(opt);
    } else {
      meatData.forEach(m => {
        const option = document.createElement("option");
        option.value = m.serial_no;
        option.textContent = `${m.cut_type} (${m.weight}kg)`;
        meatSelect.appendChild(option);
      });
    }

    /* --------------------------------------------------
       Reserve Button
    -------------------------------------------------- */
    div.querySelector(".reserveBtn").addEventListener("click", async () => {
      const serial_no = meatSelect.value;
      if (!serial_no) return alert("Select a meat first.");

      await fetch("http://localhost:3000/api/meat-selection/reserve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ serial_no, order_line_id: ol.id })
      });

      alert("Meat reserved successfully!");

      // Refresh this order line list after reservation
      fetchOrderLines(deliveryNo);
    });
  });
}

/* --------------------------------------------------
   Delivery Dropdown Listener
-------------------------------------------------- */
document.getElementById("deliverySelect").addEventListener("change", e => {
  const deliveryNo = e.target.value;
  if (deliveryNo) fetchOrderLines(deliveryNo);
});

/* --------------------------------------------------
   Initial load
-------------------------------------------------- */
fetchPendingDeliveries();

</script>
</body>
</html>
