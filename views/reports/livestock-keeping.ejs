<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carnivault - Livestock Keeping</title>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.6/dist/js/tabs.min.js" defer></script>
</head>

<body>
  <div class="flex flex-1">
    <%- include("../partials/sidebar") %>
      <main class="flex-1 p-10 overflow-y-auto bg-background">
        <h1 class="text-2xl font-bold text-foreground mb-6 tracking-tight">
          Livestock Keeping
        </h1>

        <!-- Tabs -->
        <!-- TODO: The report will display list of meat cuts -->
        <div class="tabs w-full" id="demo-tabs-with-panels">
          <nav role="tablist" aria-orientation="horizontal" class="w-full">
            <button type="button" role="tab" id="demo-tabs-with-panels-tab-1"
              aria-controls="demo-tabs-with-panels-panel-1" aria-selected="true" tabindex="0">
              Average Condition Ratio
            </button>

            <button type="button" role="tab" id="demo-tabs-with-panels-tab-2"
              aria-controls="demo-tabs-with-panels-panel-2" aria-selected="false" tabindex="0">
              Total Breed Supplied
            </button>
          </nav>

          <div role="tabpanel" id="demo-tabs-with-panels-panel-1" aria-labelledby="demo-tabs-with-panels-tab-1"
            tabindex="-1" aria-selected="true">
            <section class="flex gap-10 mt-4 w-full">
              <form class="form grid gap-6" id="filter-form-1">

                <div class="grid gap-2">
                  <label for="start-date-input-1">Start Date</label>
                  <input class="w-full" type="date" id="start-date-input-1" />
                </div>

                <div class="grid gap-2">
                  <label for="end-date-input-1">End Date</label>
                  <input class="w-full" type="date" id="end-date-input-1" />
                </div>

                <div class="grid gap-2.5">
                  <button type="submit" class="btn w-full">
                    <i data-lucide="bar-chart-2"></i>
                    Load Condition Report
                  </button>
                </div>
              </form>
              <div class="flex-1 w-full relative">
                <!-- prettier-ignore -->
                <%- include("../partials/table-skeleton", { id: "table-skeleton" })%>
                  <%- include("../partials/table", { id: "livestock-report-table" })%>
              </div>
              <!-- prettier-ignore -->
              <%- include("../partials/table-data-zero", { id: "table-data-zero" ,
                description: "Livestock data not available..." }) %>
            </section>
          </div>

          <div role="tabpanel" id="demo-tabs-with-panels-panel-2" aria-labelledby="demo-tabs-with-panels-tab-2"
            tabindex="-1" aria-selected="false" hidden>
            <section class="flex gap-10 mt-4">
              <form class="form grid gap-6">
                <div class="grid gap-2">
                  <label for="meat-cut-input">Breed</label>
                  <select class="w-full" id="meat-cut-select">
                    <option value="" disabled selected>
                      Select meat cut...
                    </option>
                    <option value="SUP-001">SUP-001 (Global Farms Inc.)</option>
                    <option value="SUP-042">
                      SUP-042 (Local Breeders Co-op)
                    </option>
                    <option value="SUP-105">SUP-105 (AgriVentures Ltd.)</option>
                    <option value="SUP-210">
                      SUP-210 (Green Valley Supplies)
                    </option>
                  </select>
                </div>

                <div class="grid gap-2">
                  <label for="meat-cut-input">Company</label>
                  <select class="w-full" id="meat-cut-select">
                    <option value="" disabled selected>
                      Select meat cut...
                    </option>
                    <option value="SUP-001">SUP-001 (Global Farms Inc.)</option>
                    <option value="SUP-042">
                      SUP-042 (Local Breeders Co-op)
                    </option>
                    <option value="SUP-105">SUP-105 (AgriVentures Ltd.)</option>
                    <option value="SUP-210">
                      SUP-210 (Green Valley Supplies)
                    </option>
                  </select>
                </div>

                <div class="grid gap-2">
                  <label for="start-date-input">Start Date</label>
                  <input class="w-full" type="date" id="start-date-input" />
                </div>

                <div class="grid gap-2">
                  <label for="end-date-input">End Date</label>
                  <input class="w-full" type="date" id="end-date-input" />
                </div>

                <div class="grid gap-2.5">
                  <button type="submit" class="btn w-full">
                    <i data-lucide="bar-chart-2"></i>
                    Load Breed Report
                  </button>
                  <a href="/livestock" type="submit" class="btn-outline w-full">
                    <i data-lucide="beef"></i>
                    View Livestock
                  </a>
                </div>
              </form>
              <table class="table">
                <thead>
                  <tr class="font-bold">
                    <td>Column #1</td>
                    <td>Column #2</td>
                    <td>Column #3</td>
                    <td>Column #4</td>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Test</td>
                    <td>Test</td>
                    <td>Test</td>
                    <td>Test</td>
                  </tr>
                  <tr>
                    <td>Test</td>
                    <td>Test</td>
                    <td>Test</td>
                    <td>Test</td>
                  </tr>
                  <tr>
                    <td>Test</td>
                    <td>Test</td>
                    <td>Test</td>
                    <td>Test</td>
                  </tr>
                  <tr>
                    <td>Test</td>
                    <td>Test</td>
                    <td>Test</td>
                    <td>Test</td>
                  </tr>
                </tbody>
              </table>
            </section>
          </div>
        </div>
      </main>
  </div>

  <script src="/scripts/components/table.js" defer></script>
  <script src="/scripts/components/searchbar.js" defer></script>
  <script src="/scripts/components/dialog.js" defer></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {

      const tableColumns = [
        "Supplier",
        "Healthy",
        "Unhealthy",
        "Healthy : Unhealthy (ratio)",
      ];

      // Initialize the table component
      await initTable(
        tableColumns,
        "livestock-report-table",
        "table-skeleton",
        "table-data-zero",
        "average-condition-ratio",
        {} // No buttons needed for this report
      );

      const tableEl = document.getElementById("livestock-report-table");
      const skeletonEl = document.getElementById("table-skeleton");
      const noDataEl = document.getElementById("table-data-zero");

      // --- HELPER: Fetch and Force UI Fix ---
      // We wrap the fetch call to ensure the UI updates correctly
      // regardless of what table.js does.
      const fetchAndRender = async (params = {}) => {
        if (tableEl && tableEl.__fetchData) {

          // 1. Show Skeleton
          tableEl.classList.add("hidden");
          noDataEl.classList.add("hidden");
          skeletonEl.classList.remove("hidden");

          // 2. Run the shared fetch logic
          await tableEl.__fetchData(params);

          // 3. FORCE UI STATE (The Fix)
          // We manually check if rows exist and force the visibility
          const hasRows = tableEl.tBodies[0].rows.length > 0;

          skeletonEl.classList.add("hidden"); // Ensure skeleton is gone

          if (hasRows) {
            // Has Data: Show Table, Hide "No Data"
            tableEl.classList.remove("hidden");
            tableEl.classList.add("table"); // Ensure Layout
            tableEl.style.display = "";     // Reset inline styles if any

            noDataEl.classList.add("hidden");
            noDataEl.classList.remove("flex");
          } else {
            // Empty: Hide Table, Show "No Data"
            tableEl.classList.add("hidden");
            tableEl.classList.remove("table");
            tableEl.style.display = "none"; // Force hide

            noDataEl.classList.remove("hidden");
            noDataEl.classList.add("flex");
          }
        }
      };

      // --- 1. Initial Load ---
      await fetchAndRender({});

      // --- 2. Filter Form Listener ---
      const form = document.getElementById("filter-form-1");
      if (form) {
        form.addEventListener("submit", async (event) => {
          event.preventDefault();

          const start = document.getElementById("start-date-input-1").value;
          const end = document.getElementById("end-date-input-1").value;

          console.log(`Refetching: ${start} to ${end}`);
          await fetchAndRender({ start, end });
        });
      }
    });
  </script>
</body>

</html>