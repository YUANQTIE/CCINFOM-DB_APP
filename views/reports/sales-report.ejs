<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carnivault - Sales Report</title>
  <script src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.6/dist/js/tabs.min.js" defer></script>
</head>

<body>
  <div class="flex flex-1">
    <%- include("../partials/sidebar") %>
      <main class="flex-1 p-10 overflow-y-auto bg-background">
        <h1 class="text-2xl font-bold text-foreground mb-6 tracking-tight">
          Sales Report
        </h1>

        <div class="tabs w-full" id="demo-tabs-with-panels">
          <nav role="tablist" aria-orientation="horizontal" class="w-full">
            <button type="button" role="tab" id="demo-tabs-with-panels-tab-1"
              aria-controls="demo-tabs-with-panels-panel-1" aria-selected="true" tabindex="0">
              Profit By Client
            </button>

            <button type="button" role="tab" id="demo-tabs-with-panels-tab-2"
              aria-controls="demo-tabs-with-panels-panel-2" aria-selected="false" tabindex="0">
              Total Profit
            </button>
          </nav>

          <div role="tabpanel" id="demo-tabs-with-panels-panel-1" aria-labelledby="demo-tabs-with-panels-tab-1"
            tabindex="-1" aria-selected="true">
            <section class="flex flex-col gap-6 mt-4 w-full">

              <form class="form grid gap-6" id="form-tab-1">
                <div class="grid gap-2">
                  <label for="client-select">Client Name</label>
                  <select class="w-full" id="client-select" required>
                    <option value="" disabled selected>Loading clients...</option>
                  </select>
                </div>

                <div class="grid gap-2">
                  <label for="start-date-1">Start Date</label>
                  <input class="w-full" type="date" id="start-date-1" required />
                </div>

                <div class="grid gap-2">
                  <label for="end-date-1">End Date</label>
                  <input class="w-full" type="date" id="end-date-1" required />
                </div>

                <div class="grid gap-2.5">
                  <button type="submit" class="btn w-full">
                    <i data-lucide="dollar-sign"></i>
                    Load Profit By Client
                  </button>
                </div>
              </form>

              <div id="result-container-1"
                class="hidden flex flex-col items-center justify-center p-10 border rounded-lg bg-muted/20">
                <h3 class="text-lg font-medium text-muted-foreground mb-2">Client Profit</h3>
                <span id="result-display-1" class="text-6xl font-bold text-primary tracking-tighter">
                  --
                </span>
              </div>

              <div id="error-message-1" class="hidden text-red-500 text-center font-medium"></div>
            </section>
          </div>

          <div role="tabpanel" id="demo-tabs-with-panels-panel-2" aria-labelledby="demo-tabs-with-panels-tab-2"
            tabindex="-1" aria-selected="false" hidden>
            <section class="flex flex-col gap-6 mt-4">

              <form class="form grid gap-6" id="form-tab-2">
                <div class="grid gap-2">
                  <label for="start-date-2">Start Date</label>
                  <input class="w-full" type="date" id="start-date-2" required />
                </div>

                <div class="grid gap-2">
                  <label for="end-date-2">End Date</label>
                  <input class="w-full" type="date" id="end-date-2" required />
                </div>

                <div class="grid gap-2.5">
                  <button type="submit" class="btn w-full">
                    <i data-lucide="trending-up"></i>
                    Load Total Profit Report
                  </button>
                </div>
              </form>

              <div id="result-container-2"
                class="hidden flex flex-col items-center justify-center p-10 border rounded-lg bg-muted/20">
                <h3 class="text-lg font-medium text-muted-foreground mb-2">Total Profit Generated</h3>
                <span id="result-display-2" class="text-6xl font-bold text-primary tracking-tighter">
                  --
                </span>
              </div>

              <div id="error-message-2" class="hidden text-red-500 text-center font-medium"></div>
            </section>
          </div>
        </div>
      </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {

      const formatCurrency = (amount) => {
        if (amount === null || amount === undefined) return "PHP0.00";
        return new Intl.NumberFormat('en-PH', {
          style: 'currency',
          currency: 'PHP'
        }).format(amount);
      };
      async function loadClients() {
        const selectEl = document.getElementById("client-select");
        if (!selectEl) return;

        try {
          const response = await fetch("/api/unique-clients");
          if (!response.ok) throw new Error("Failed to load clients");
          const clients = await response.json();

          selectEl.innerHTML = '<option value="" disabled selected>Select Client...</option>';

          clients.forEach(c => {
            const option = document.createElement("option");
            option.value = c.restaurant_name;
            option.textContent = c.restaurant_name;
            selectEl.appendChild(option);
          });
        } catch (error) {
          console.error(error);
          selectEl.innerHTML = '<option value="" disabled selected>Error loading clients</option>';
        }
      }

      await loadClients();

      // ------------------------------------------------------
      // TAB 1: Profit By Client
      // ------------------------------------------------------
      const form1 = document.getElementById("form-tab-1");
      if (form1) {
        form1.addEventListener("submit", async (event) => {
          event.preventDefault();

          const client = document.getElementById("client-select").value;
          const start = document.getElementById("start-date-1").value;
          const end = document.getElementById("end-date-1").value;

          const resultContainer = document.getElementById("result-container-1");
          const resultDisplay = document.getElementById("result-display-1");
          const errorDisplay = document.getElementById("error-message-1");

          if (!client || !start || !end) return alert("Please fill in all fields");

          try {
            resultContainer.classList.remove("hidden");
            resultDisplay.innerText = "...";
            errorDisplay.classList.add("hidden");

            const url = new URL("/api/profit/client", window.location.origin);
            url.searchParams.append("client", client);
            url.searchParams.append("start", start);
            url.searchParams.append("end", end);

            const response = await fetch(url);
            const data = await response.json();

            if (response.ok && data.length > 0) {
              resultDisplay.innerText = formatCurrency(data[0].total_profit);
            } else {
              resultDisplay.innerText = formatCurrency(0);
            }
          } catch (error) {
            console.error(error);
            resultContainer.classList.add("hidden");
            errorDisplay.innerText = "Failed to load data.";
            errorDisplay.classList.remove("hidden");
          }
        });
      }

      // ------------------------------------------------------
      // TAB 2: Total Profit
      // ------------------------------------------------------
      const form2 = document.getElementById("form-tab-2");
      if (form2) {
        form2.addEventListener("submit", async (event) => {
          event.preventDefault();

          const start = document.getElementById("start-date-2").value;
          const end = document.getElementById("end-date-2").value;

          const resultContainer = document.getElementById("result-container-2");
          const resultDisplay = document.getElementById("result-display-2");
          const errorDisplay = document.getElementById("error-message-2");

          if (!start || !end) return alert("Please select dates");

          try {
            resultContainer.classList.remove("hidden");
            resultDisplay.innerText = "...";
            errorDisplay.classList.add("hidden");

            const url = new URL("/api/profit/total", window.location.origin);
            url.searchParams.append("start", start);
            url.searchParams.append("end", end);

            const response = await fetch(url);
            const data = await response.json();

            if (response.ok && data.length > 0) {
              resultDisplay.innerText = formatCurrency(data[0].total_profit);
            } else {
              resultDisplay.innerText = formatCurrency(0);
            }
          } catch (error) {
            console.error(error);
            resultContainer.classList.add("hidden");
            errorDisplay.innerText = "Failed to load data.";
            errorDisplay.classList.remove("hidden");
          }
        });
      }
    });
  </script>
</body>

</html>