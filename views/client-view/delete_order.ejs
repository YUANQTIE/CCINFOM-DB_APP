<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancel Pending Orders</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 min-h-screen">

    <div class="flex flex-1">

        <%- include("../clients_partials/sidebar") %>

            <div class="flex-grow p-8">

                <header class="w-full max-w-6xl mb-8 mx-auto">
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Pending Orders for <%= clientName %>
                    </h1>
                    <p class="text-gray-600">Cancel orders that are still pending for this client.</p>
                </header>

                <div class="w-full max-w-6xl mb-6 mx-auto space-y-6">

                    <div id="ordersContainer" class="bg-white p-6 rounded-lg shadow-md border-t-4 border-red-500">
                        <p class="text-gray-500">Loading orders...</p>
                    </div>

                </div>

            </div>
    </div>

    <footer class="w-full max-w-6xl mt-12 text-center text-xs text-gray-400 mx-auto">
        &copy; 2025 Carnivault. All rights reserved.
    </footer>

    <script>
        async function loadPendingOrders() {
            const email = "<%= clientEmail %>";
            const container = document.getElementById("ordersContainer");

            if (!email) {
                container.innerHTML = "<p class='text-red-500'>Client email not provided.</p>";
                return;
            }

            container.innerHTML = "<p class='text-gray-500'>Loading orders...</p>";

            try {
                const res = await fetch(`/api/client/pending-orders?email=${encodeURIComponent(email)}`);
                const data = await res.json();

                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = "<p class='text-gray-500'>No pending orders found.</p>";
                    return;
                }

                renderOrders(data);
            } catch (err) {
                console.error(err);
                container.innerHTML = "<p class='text-red-500'>Error loading orders.</p>";
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById("ordersContainer");
            container.innerHTML = "";

            const table = document.createElement("table");
            table.className = "min-w-full border border-gray-300 rounded-lg";

            const thead = document.createElement("thead");
            thead.className = "bg-gray-100";
            thead.innerHTML = `
        <tr>
          <th class="border px-4 py-2">Delivery No</th>
          <th class="border px-4 py-2">Order Line ID</th>
          <th class="border px-4 py-2">Cut Type</th>
          <th class="border px-4 py-2">Order Date</th>
          <th class="border px-4 py-2">Status</th>
          <th class="border px-4 py-2">Action</th>
        </tr>
      `;
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            orders.forEach(o => {
                const tr = document.createElement("tr");
                tr.className = "hover:bg-gray-50";
                tr.innerHTML = `
          <td class="border px-4 py-2">${o.delivery_no}</td>
          <td class="border px-4 py-2">${o.id}</td>
          <td class="border px-4 py-2">${o.cut_type_of_choice}</td>
          <td class="border px-4 py-2">${o.order_date}</td>
          <td class="border px-4 py-2">${o.status}</td>
          <td class="border px-4 py-2">
            <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded" onclick="cancelOrder(${o.id})">Cancel</button>
          </td>
        `;
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            container.appendChild(table);
        }

        async function cancelOrder(orderLineId) {
            if (!confirm("Are you sure you want to cancel this order?")) return;

            try {
                const res = await fetch(`/api/order-line/${orderLineId}`, { method: "DELETE" });
                const data = await res.json();

                if (data.success) {
                    alert("Order cancelled successfully.");
                    loadPendingOrders();
                } else {
                    alert("Failed: " + (data.error || "Unknown error"));
                }

            } catch (err) {
                console.error(err);
                alert("Error cancelling order.");
            }
        }

        loadPendingOrders();
    </script>

</body>

</html>