<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carnivault - Livestock</title>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3/cdn.min.js"></script>
</head>

<body>
  <div class="flex flex-1">
    <%- include("../partials/sidebar") %>
      <main class="flex-1 p-10 overflow-y-auto bg-background">
        <h1 class="text-2xl font-bold text-foreground mb-6 tracking-tight">
          Livestock
        </h1>
        <section class="flex flex-col gap-4">
          <!-- prettier-ignore -->
          <section class="flex justify-between">
            <%- include("../partials/searchbar", { label: "Livestock" , select_id: "searchbarSelect" ,
              input_id: "searchbarInput" , placeholder: "Search livestock..." , route_api: "livestock" }) %>
              <div class="grid gap-2 grid-flow-col">
                <a href="/reports/inventory-keeping" class="btn-outline">
                  <i data-lucide="bar-chart-2"></i>
                  View Reports
                </a>
                <a href="/suppliers" class="btn-outline">
                  <i data-lucide="users" class="h-4.5"></i>
                  View Suppliers
                </a>

                <button class="btn" id="add-livestock-btn">
                  <i data-lucide="house-plus" class="h-4.5"></i>
                  Add Livestock
                </button>

                <!-- prettier-ignore -->
                <%- include('../partials/dialog', { dialogId: 'add-livestock-dialog' , title: 'Add Livestock' ,
                  description: 'Add livestock.' , formId: 'add-livestock-form' , formAction: '/api/livestock/add' ,
                  formMethod: 'POST' , submitText: 'Add' , formFieldsPartial: '../partials/add-livestock-dialog' }) %>

                  <%- include('../partials/dialog', { dialogId: 'edit-livestock-dialog' , title: 'Edit Livestock' ,
                    description: 'Update the medical condition and vaccination status.' , formId: 'edit-livestock-form'
                    , formAction: '' , formMethod: 'POST' , submitText: 'Update' ,
                    formFieldsPartial: '../partials/edit-livestock-dialog' }) %>
              </div>
          </section>
          <div class="overflow-x-auto">
            <!-- prettier-ignore -->
            <%- include("../partials/table-skeleton", { id: "table-skeleton" })%>
              <%- include("../partials/table", { id: "livestock-table" })%>
          </div>
          <!-- prettier-ignore -->
          <%- include("../partials/table-data-zero", { id: "table-data-zero" ,
            description: "Livestock data not available..." }) %>
        </section>
      </main>
  </div>

  <script src="/scripts/components/table.js" defer></script>
  <script src="/scripts/components/searchbar.js" defer></script>
  <script src="/scripts/components/dialog.js" defer></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("edit-medical-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const dialog = document.getElementById("edit-livestock-dialog");
        const id = dialog.dataset.livestock_id;

        const condition = document.getElementById("medical-input").value;

        const response = await fetch(`/api/livestock/${id}/condition`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ medical_condition: condition })
        });

        if (response.ok) {
          console.log("Medical condition updated!");
          dialog.close();
          window.location.reload();
        } else {
          console.log("Error updating medical condition.");
        }
      });


      document.getElementById("edit-vaccine-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const dialog = document.getElementById("edit-livestock-dialog");
        const id = dialog.dataset.livestock_id;

        const vaccine = document.getElementById("vaccination-select").value;

        const response = await fetch(`/api/livestock/${id}/vaccination`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ vaccination_status: vaccine })
        });

        if (response.ok) {
          console.log("Vaccination status updated!");
          dialog.close();
          window.location.reload();
        } else {
          console.log("Error updating vaccination status.");
        }
      });
      const tableColumns = [
        "Livestock ID",
        "Breed",
        "Weight",
        "Age",
        "Country of Origin",
        "Medical Condition",
        "Vaccination Status",
        "Date Arrived",
        "Storage Location",
        "Supplier ID",
        "Status",
        "Processing Date",
      ];

      const buttons = {
        editBtn: {
          action: (event, rowData, rowIndex) => {
            const dialog = document.getElementById("edit-livestock-dialog");

            // Pre-fill values
            document.getElementById("medical-input").value = rowData.medical_condition;
            document.getElementById("vaccination-select").value = rowData.vaccination_status;

            // Store ID for both forms
            dialog.dataset.livestockId = rowData.livestock_id;

            dialog.showModal();
            console.log("Edit");
          },
          icon: lucide.icons.Pencil,
        },
        processLivestockBtn: {
          action: async (event, rowData, rowIndex) => {
            const livestock_id = rowData.livestock_id; // or whatever your key is

            try {
              const response = await fetch(`/api/livestock/process/${livestock_id}`, {
                method: "POST",
              });

              if (!response.ok) {
                throw new Error("Failed to process livestock");
              }

              window.location.reload();
            } catch (err) {
              console.error(err);
              alert("Error processing livestock.");
            }
          },
          label: "Process",
          condition: (rowData) => rowData.status === "For Processing"
        },
      };

      initTable(
        tableColumns,
        "livestock-table",
        "table-skeleton",
        "table-data-zero",
        "livestock",
        buttons
      );

      initSearchBar(
        "searchbarSelect",
        "searchbarInput",
        "livestock-table",
        "livestock",
        tableColumns,
        buttons
      );

      // Dialog
      initDialog(
        "add-livestock-btn",
        "add-livestock-dialog",
        "add-livestock-form",
        "/api/livestock/add",
        "POST"
      );

      // For processing
      const actionsGroup = document.getElementById("actionsGroup");
      console.log(actionsGroup);
    });
  </script>
</body>

</html>