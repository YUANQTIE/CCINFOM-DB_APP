<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carnivault - Suppliers</title>

    <script src="https://cdn.jsdelivr.net/npm/date-fns@3/cdn.min.js"></script>
  </head>
  <body>
    <div class="flex flex-1">
      <%- include("./partials/sidebar") %>
      <main class="flex-1 p-10 overflow-y-auto bg-background">
        <div class="flex gap-4">
          <h1 class="text-2xl font-bold text-foreground mb-6 tracking-tight">
            Suppliers
          </h1>
        </div>
        <section class="flex flex-col gap-4">
          <section class="flex justify-between">
            <!-- prettier-ignore -->
            <%- include("./partials/searchbar", { label: "Suppliers", select_id: "searchbar", placeholder: "Search suppliers..." }) %>
            <div class="grid gap-2 grid-flow-col">
              <a href="/livestock" class="btn-outline">
                <i data-lucide="rabbit" class="h-4.5"></i>
                View Livestock
              </a>
              <a href="/livestock/register" class="btn">
                <i data-lucide="house-plus" class="h-4.5"></i>
                Add Livestock
              </a>
            </div>
          </section>
          <div class="overflow-x-auto">
            <%- include("./partials/table-skeleton", { id: "table-skeleton"}) %>
            <table id="livestock-table" class="hidden">
              <thead>
                <tr>
                  <th>Livestock ID</th>
                  <th>Breed</th>
                  <th>Weight</th>
                  <th>Age</th>
                  <th>Country of Origin</th>
                  <th>Medical Condition</th>
                  <th>Vaccination Status</th>
                  <th>Date Arrived</th>
                  <th>Storage Location</th>
                  <th>Supplier ID</th>
                  <th>Status</th>
                  <th>Processing Date</th>
                </tr>
              </thead>
              <tbody id="livestock-table-body"></tbody>
            </table>
          </div>
          <!-- prettier-ignore -->
          <%- include("./partials/table-data-zero", { id: "table-data-zero", description: "Livestock data not available..."}) %>
        </section>
      </main>
    </div>

    <script type="module" src="/scripts/pages/suppliers.js"></script>

    <script>
      // --- Utility Functions ---

      // --- DOM & UI Functions ---
      function setUIState(state, elements) {
        const { table, tableSkeleton, tableDataZeroLabel } = elements;

        table.classList.add("hidden");
        tableSkeleton.classList.add("hidden");
        tableDataZeroLabel.classList.add("hidden");

        if (state === "loading") {
          tableSkeleton.classList.remove("hidden");
        } else if (state === "success") {
          table.classList.replace("hidden", "table");
        } else if (state === "empty") {
          tableDataZeroLabel.textContent = "No livestock data found.";
          tableDataZeroLabel.classList.replace("hidden", "flex");
        } else if (state === "error") {
          tableDataZeroLabel.textContent = "Error fetching livestock data.";
          tableDataZeroLabel.classList.replace("hidden", "flex");
        }
      }

      function createLivestockRow(livestock) {
        const row = document.createElement("tr");

        const createCell = (text) => {
          const cell = document.createElement("td");
          cell.textContent = text || "-/-";
          row.appendChild(cell);
        };

        createCell(livestock.livestock_id);
        createCell(livestock.breed);
        createCell(livestock.weight);
        createCell(livestock.age);
        createCell(livestock.country_of_origin);
        createCell(livestock.medical_condition);
        createCell(livestock.vaccination_status);
        createCell(formatDateSafe(livestock.date_arrived));
        createCell(livestock.storage_location);
        createCell(livestock.supplier_id);
        createCell(livestock.status);
        createCell(formatDateSafe(livestock.processing_date));

        return row;
      }

      function populateTable(data, tableBody) {
        tableBody.innerHTML = "";
        const fragment = document.createDocumentFragment();
        data.forEach((livestock) => {
          fragment.appendChild(createLivestockRow(livestock));
        });
        tableBody.appendChild(fragment);
      }

      // --- Data Fetching ---
      async function fetchLivestockData() {
        const response = await fetch("/api/livestock");

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return await response.json();
      }

      // --- Main Application ---
      async function init() {
        const elements = {
          tableSkeleton: document.getElementById("table-skeleton"),
          table: document.getElementById("livestock-table"),
          tableDataZeroLabel: document.getElementById("table-data-zero"),
          tableBody: document.getElementById("livestock-table-body"),
        };

        if (Object.values(elements).some((el) => !el)) {
          console.error("A required table element is missing!");
          return;
        }

        initSearchBar(tableColumns);
        setUIState("loading", elements);

        try {
          const data = await fetchLivestockData();

          if (data.length === 0) {
            setUIState("empty", elements);
          } else {
            populateTable(data, elements.tableBody);
            setUIState("success", elements);
          }
        } catch (error) {
          console.error("Error fetching livestock data:", error);
          setUIState("error", elements);
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
